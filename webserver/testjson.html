<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        .fade-enter-active {
            animation: go 2s;
        }

        @keyframes go {
            from{
                opacity: 0 ;
                -webkit-transform: translateX(100%)
            }

            to {
                opacity: 1.0;
                -webkit-transform: translateX(0%)
            }
        }

        .unit{
            background-color:mediumseagreen
        }
        .g{
            background-color:aqua
        }
        body{
            background-color: black
        }
    </style>
</head>

<body>
    <div id="d" >
        <transition-group appear appear-active-class="fade-enter-active">
            <div v-for="(item,index) in list" :key="item.id" :id="item.id" :title="item.title"
                style="width:1225px;height:820px;border:1px solid black;padding: 5px;margin: 3px" class="unit">

                <div id="graph1" 
                    style="width:600px;height:400px;float: left;border:1px solid black;margin: 3px" class="g">
                </div>
                <div id="graph2" 
                    style="width:600px;height:400px;float: right;border:1px solid black;margin: 3px" class="g">
                </div>
                <br>
                <div id="graph3" 
                    style="width:600px;height:400px;float: left;border:1px solid black;margin: 3px" class="g">
                </div>
                <div id="graph2" 
                    style="width:600px;height:400px;float: right;border:1px solid black;margin: 3px" class="g">
                </div>

            </div>
        </transition-group>
    </div>


    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-----https://github.com/plotly/plotly.js/><!-->
    
    <!-- 开发环境版本，包含了有帮助的命令行警告 -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script> -->
    <!-- 生产环境版本，优化了尺寸和速度 -->
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script>
        //init dom
        var vm = new Vue({
            el: '#d',
            delimiters: ['${', '}'],
            data: {
                list: [
                    { id: 'd01', title: 'device 01' },
                    { id: 'd02', title: 'device 02' },
                    { id: 'd03', title: 'device 03' }
                ]
            }
        });
        //global var
        let webserver = "http://showdata.nctu.me/webserver/testjson.php";
        if (location.protocol == "https:") {
            webserver = "https://showdata.nctu.me/webserver/testjson.php";
        }

        let normalColor = '#80CAF6';
        let wraningColor = "red";
        let unknown = 0;//unknown value
        let timeout=10000;//10s
        //devices01
        {
            let sensorNum = 2;//sensor num
            let delay = 5000;//refresh rate in ms
            let tarray = new Array();//time array
            let darray = new Array();//data array
            let txtarray=new Array();//text array
            let graphSet = ["graph1", "graph2"];
            let titleSet = ["devices01-sensor01", "devices01-sensor02"];
            let pastLimit = 100;//how many points can look back
            let target = "devices01"


            //call refresh in fixed time
            setInterval(refresh, delay);

            //initialize plotly.js
            let now = new Date();
            let pre = now;//pre time holder
            let data = [{
                x: [now],
                y: [0],
                mode: 'lines+markers',
                line: { color: normalColor }
            }];

            //initialize time and data array to nested
            //start plot
            for (let i = 0; i < sensorNum; i++) {
                tarray[i] = [];
                darray[i] = [];
                txtarray[i]=[];
                Plotly.plot(graphSet[i], data, { title: titleSet[i] });
            }


            //refresh data from web server
            function refresh() {
                let request = new XMLHttpRequest();
                request.timeout=timeout;
                request.ontimeout=function(e){console.log("web server no response");};
                request.addEventListener("readystatechange", function () {
                    if (this.readyState == 4) {// 4 => complete
                        console.log(this.responseText);
                        let ar = this.responseText.split(";");

                        let devicesid = ar[0];//devicesid
                        let devicesstatus = ar[1];//devicesstatus
                        let time = new Date(ar[2]);//time
                        let obj = JSON.parse(ar[3]);//json value
                        console.log(new Date(ar[2]).toString());
                        for (const iterator of obj) {
                            console.log(iterator);
                        }


                        if (time.valueOf() == pre.valueOf()) {//dulplicate

                        } else {//not dulplicate
                            pre = time;//update pre time holder

                            for (let i = 0; i < obj.length; i++) {//loop dif sensor graph
                                //append new data
                                let value = obj[i].value;
                                if (value == "unknown") {
                                    value = unknown
                                }
                                tarray[i].unshift(time);
                                darray[i].unshift(value);
                                txtarray[i].unshift((devicesstatus == "unavailable" ? devicesstatus : (obj[i].status)));
                                let color = normalColor;//set line color

                                //update data set
                                let update = {
                                    x: [tarray[i]],
                                    y: [darray[i]],
                                    line: { color: color },
                                    text: [txtarray[i]],
                                    textposition: "top"
                                };

                                //prepare view obj
                                let olderTime = time.setMinutes(time.getMinutes() - 1);
                                let futureTime = time.setMinutes(time.getMinutes() + 1);
                                let min = Math.min(...darray[i]);
                                let max = Math.max(...darray[i]);
                                let dif = max - min;
                                let minuteView = {
                                    'yaxis.range': [min - dif, max + dif],
                                    'yaxis.title': obj[i].type,
                                    xaxis: {
                                        type: 'date',
                                        range: [olderTime, futureTime]
                                    },
                                    title: titleSet[i] + "<br>" + (devicesstatus == "unavailable" ? devicesstatus : (obj[i].status))
                                }
                                //set view point and update data
                                Plotly.relayout(graphSet[i], minuteView);
                                Plotly.update(graphSet[i], update);

                                //clear too many data if in need
                                if (tarray[i].length > pastLimit) {
                                    tarray[i].pop();
                                    darray[i].pop();
                                    txtarray[i].pop();
                                }
                            }
                        }
                    }
                });

                //send http get request to webserver
                request.open("GET", webserver + "?target=" + target, true);
                request.send();
            }
        }
    </script>
</body>

</html>