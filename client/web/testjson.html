<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>

    </style>
</head>

<body>
    <div id="g01" style="width:1225px;height:820px;border:1px solid black;padding: 5px;margin: 3px">
        <div id="graph1" style="width:600px;height:400px;float: left;border:1px solid black;margin: 3px"></div>
        <div id="graph2" style="width:600px;height:400px;float: right;border:1px solid black;margin: 3px"></div>
        <br>
        <div id="graph3" style="width:600px;height:400px;float: left;border:1px solid black;margin: 3px"></div>
    </div>
    <div id="g02" style="width:1225px;height:820px;border:1px solid black;padding: 5px;margin: 3px">
            <div id="graph1" style="width:600px;height:400px;float: left;border:1px solid black;margin: 3px"></div>
            <div id="graph2" style="width:600px;height:400px;float: right;border:1px solid black;margin: 3px"></div>
            <br>
            <div id="graph3" style="width:600px;height:400px;float: left;border:1px solid black;margin: 3px"></div>
    </div>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-----https://github.com/plotly/plotly.js/><!-->
    <script>
        //global var
        let webserver="http://showdata.nctu.me/testjson.php";
        if(location.protocol=="https:"){
            webserver="https://showdata.nctu.me/testjson.php";
        }

        let normalColor='#80CAF6';
        let wraningColor="red";
        let unknown=0;//unknown value
        //devices01
        {
            let sensorNum=2;//sensor num
            let delay=5000;//refresh rate in ms
            let tarray = new Array();//time array
            let darray = new Array();//data array
            let graphSet=["graph1","graph2"];
            let titleSet=["devices01-sensor01","devices01-sensor02"];
            let pastLimit=100;//how many points can look back
            let target="devices01"
            

            //call refresh in fixed time
            setInterval(refresh,delay);
            
            //initialize plotly.js
            let now = new Date();
            let pre = now;//pre time holder
            let data = [{
                x: [now],
                y: [0],
                mode: 'lines+markers',
                line: { color: normalColor }
            }];
            
            //initialize time and data array to nested
            //start plot
            for(let i=0;i<sensorNum;i++){
                tarray[i] = []; darray[i] = [];
                Plotly.plot(graphSet[i], data, { title:titleSet[i]});
            }
            

            //refresh data from web server
            function refresh() {
                let request = new XMLHttpRequest();
                request.addEventListener("readystatechange", function () {
                    if (this.readyState == 4) {// 4 => complete
                        console.log(this.responseText);
                        let ar = this.responseText.split(";");

                        let devicesid = ar[0];//devicesid set to 0
                        let devicesstatus = ar[1];//devicesstatus
                        let time = new Date(ar[2]);//time
                        let obj = JSON.parse(ar[3]);//json value
                        console.log(new Date(ar[2]).toString());
                        for (const iterator of obj) {
                            console.log(iterator);
                        }


                        if (time.valueOf() == pre.valueOf()) {//dulplicate
                        
                        } else {//not dulplicate
                            pre = time;//update pre time holder

                            for (let i = 0; i < obj.length; i++) {//loop dif sensor graph
                                //append new data
                                let value = obj[i].value;
                                if(value=="unknown"){
                                    value=unknown
                                }
                                tarray[i].unshift(time);
                                darray[i].unshift(value);
                                
                                let color =normalColor;//set line color

                                //update data set
                                let update = {
                                    x: [tarray[i]],
                                    y: [darray[i]],
                                    line: { color: color },
                                    text:[(devicesstatus=="unavailable"?devicesstatus:(obj[i].status))],
                                    textposition:"top"
                                };

                                //prepare view obj
                                let olderTime = time.setMinutes(time.getMinutes() - 1);
                                let futureTime = time.setMinutes(time.getMinutes() + 1);
                                let min = Math.min(...darray[i]);
                                let max = Math.max(...darray[i]);
                                let dif = max - min;
                                let minuteView = {
                                    'yaxis.range': [min - dif, max + dif],
                                    'yaxis.title':obj[i].type,
                                    xaxis: {
                                        type: 'date',
                                        range: [olderTime, futureTime]
                                    },
                                    title:titleSet[i]+"<br>"+(devicesstatus=="unavailable"?devicesstatus:(obj[i].status))
                                }
                                //set view point and update data
                                Plotly.relayout(graphSet[i], minuteView);
                                Plotly.update(graphSet[i], update);

                                //clear too many data if in need
                                if (tarray[i].length > pastLimit) {
                                    tarray[i].pop();
                                    darray[i].pop();
                                }
                            }
                        }
                    }
                });

                //send http get request to webserver
                request.open("GET", webserver+"?target="+target, true);
                request.send();
            }
        }
    </script>
</body>

</html>