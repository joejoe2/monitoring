<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <div id="graph" style="width:600px;height:400px;"></div>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-----https://github.com/plotly/plotly.js/><!-->
    <script>
        let array1=new Array();
        let array2=new Array();
        function refresh() {
            let request = new XMLHttpRequest();
            request.addEventListener("readystatechange", function () {
                if (this.readyState == 4) {
                    console.log(this.responseText);
                    let ar = this.responseText.split(";");
                    
                    let gatewayid=ar[0];
                    
                    let gatewaystatus=ar[1];

                    let obj = JSON.parse(ar[3]);
                    console.log(new Date(ar[2]).toString());
                    for (const iterator of obj) {
                        console.log(iterator);
                    }
                    let time = new Date(ar[2]);

                    if(time.valueOf()==pre.valueOf()){
                        //console.log("dul");
                    }else{
                        //console.log("not dul");
                        pre=time;
                        array1.unshift(time);
                        array2.unshift(obj[0].value);
                        let update = {
                            x: [array1],
                            y: [array2]
                        };
                        
                        let olderTime = time.setMinutes(time.getMinutes() - 1);
                        let futureTime = time.setMinutes(time.getMinutes() + 1);

                        let min=Math.min(...array2);
                        let max=Math.max(...array2);
                        let dif=max-min;
                        let minuteView = {
                            'yaxis.range': [min-dif,max+dif],
                            xaxis: {
                                type: 'date',
                                range: [olderTime, futureTime]
                            }
                        };

                        Plotly.relayout('graph', minuteView);
                        Plotly.update('graph', update);

                        if(array1.length>100){
                            array1.pop();
                            array2.pop();
                        }
                    }
                    }
                });
            request.open("GET", "testjson.php", true);
            request.send();
        }
        setInterval(refresh, 5000);
        //-------------------------------------
        let now = new Date();
        let pre=now;
        let data = [{
            x: [now],
            y: [0],
            mode: 'lines+markers',
            line: { color: '#80CAF6' }
        }];
        Plotly.plot('graph', data);
    </script>
</body>

</html>